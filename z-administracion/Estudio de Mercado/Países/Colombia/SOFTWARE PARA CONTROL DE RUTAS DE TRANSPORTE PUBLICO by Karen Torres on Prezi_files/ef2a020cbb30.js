Share.Views.EmbedModalView=Backbone.View.extend({el:"#btn_share_embed, #ln_embed_modal:not(.disabled)",events:{click:"handleEmbedClick"},template:$("#embed_modal")[0].innerHTML,handleEmbedClick:function(e){if(!this.modal){this.modal=$(Mustache.render(this.template,{}));this.modal.appendTo($("body"));this.$embed_code_input=$("#embed-code-input")}this.modal.modal();$("input.embed-code-regen").click($.proxy(this.generateEmbedCode,this));$("input.embed-code-regen-dim").change($.proxy(this.generateEmbedCode,this));this.$embed_code_input.click(function(){$(this).select()});$("#embed-code-copy-ln").css("z-index",1200).copy_button(this.$embed_code_input);this.generateEmbedCode()},isValidData:function(data){var re=/[^0-9]+$/,isValid=true;if(re.test(data.width)||re.test(data.height)){var errorLabel=$("<p/>",{text:gettext("Please use only numbers for dimensions")}).addClass("error");$("#block_embed_dimensions").prepend(errorLabel);setTimeout(function(){errorLabel.animate({opacity:0},300,function(){errorLabel.remove()})},5e3);isValid=false}return isValid},generateEmbedCode:function(){var data={width:$("#embed-code-width").val(),height:$("#embed-code-height").val(),lock:$("#embed-nav-constrain").is(":checked")};if(!this.isValidData(data)){return}var is_prezi_public=false;if(Share.Views.sliderView){is_prezi_public=Share.Views.sliderView.model.get("privacy")!="private"}else{is_prezi_public=this.model.get("permissions")["public"]}if(is_prezi_public||this.embedkey){if(is_prezi_public){data.id=this.model.get("oid")}else{data.id=this.embedkey}this.refreshEmbedCode(data)}else{var that=this;$.ajax({url:"/embedkey/"+this.model.get("oid")+"/",dataType:"json",beforeSend:function(request){request.setRequestHeader("X-CSRFToken",Share.helpers.getCsrfToken()||"")},success:function(ajax_data){if(!ajax_data.key){Share.broker.trigger("notification:embed:error",ajax_data.error)}else{that.embedkey=ajax_data.key;data.id=that.embedkey;that.refreshEmbedCode(data)}},error:function(){Share.broker.trigger("notification:embed:error",gettext("Error during generating embed code"))}})}},refreshEmbedCode:function(data){var code=EMBEDCODE.getHTML({id:data.id,title:this.model.get("permissions").title,description:$("#prezi_description b").text(),slug:this.model.get("slug"),external:1,iframe_embed_external:this.model.get("iframe_embed_external"),width:data.width,height:data.height,html5:window.html5_landing_embed_code_on?"1":undefined,lock:data.lock});this.$embed_code_input.val(code)}});

$(function(){if(!Site.disableEmbedApp&&!Share.Views.embed_modal){var embed_model=new Share.Models.Presentation({oid:Prezi.data.oid,permissions:Prezi.data.permissions,slug:Prezi.data.slug,iframe_embed_external:Prezi.data.iframe_embed_external});var embed_notification=new Share.Views.Notification({el:"#embed-modal-heading",event_prefix:"embed"});Share.Views.embed_modal=new Share.Views.EmbedModalView({model:embed_model});if(window.location.hash&&window.location.hash=="#share_embed"){Share.Views.embed_modal.handleEmbedClick()}}Mustache.tags=["<%=","%>"]});
